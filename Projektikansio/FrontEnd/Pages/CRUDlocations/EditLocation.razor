@page "/locations/edit/{Id:long}"

@using System.Net.Http
@using System.Net.Http.Json
@using System.Threading.Tasks

@inject NavigationManager NavigationManager
@inject ILogger<Index> Logger
@inject HttpClient Http
@inject SharedLib.LoginState loginState;

@*@Mahdollisuus lisätä kuva? Miten!?!?
    tee myös vetovalikko vaihtoehdoille*@

@if (loginState.isLoggedIn) { 

    @if (location != null)
    {
        <h3>Muokataan matkakohdetta @location.kohdenimi</h3>
        <div style="text-align:center">
            <EditForm Model="@location" OnValidSubmit="@EditLocations">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div>
                    <label>
                        @if (@location.kuva == null)
                        {
                            <div>Ei kuvaa saatavilla</div>
                        }
                        else
                        {
                            <div style="text-align:center"><img src="tripPictures/@location.kuva" width="133" height="133" alt="1" /></div>
                        }
                        Kuva
                        <InputText class="form-control" id="kuva" @bind-Value="location.kuva" />
                    </label>
                </div>
                <div>
                    <label>
                        Kohdenimi
                        <InputText class="form-control" id="kohdenimi" @bind-Value="location.kohdenimi" />
                    </label>
                </div>
                <div>
                    <label>
                        Paikkakunta
                        <InputText class="form-control" id="paikkakunta" @bind-Value="location.paikkakunta" />
                    </label>
                </div>
                <div>
                    <label>
                        Maa
                        <InputText class="form-control" id="maa" @bind-Value="location.maa" />
                    </label>
                </div>
                <div>
                    <label>
                        Kuvausteksti
                        <InputText class="form-control" id="kuvausteksti" @bind-Value="location.kuvausteksti" />
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" disabled="@isSubmitting">Lisää</button>
            </EditForm>
        </div>
    }
 
    
    @if(r == 1){@*Jos r = 1, se tarkoittaa ettei matkakohdetta muokattu, koska se sisälsi tarinan*@
        <div style="text-align:center"><h3>Matkakohde sisältää tarinan.<br/>Matkakohdetta ei voi muokata.</h3></div>
    }
}
else
{
    <h2>  <img src="/images/loading.gif" width="150" /></h2>
    <h2>Kirjaudu sisään muokataksesi matkakohteita</h2>
}


@code {

    bool isSubmitting;
    SharedLib.matkakohdeDTO? location;
    int? r; 

    [Parameter]
    public long? Id { get; set; }



    protected override async Task OnInitializedAsync()
    {
        try{
            location = await Http.GetFromJsonAsync<SharedLib.matkakohdeDTO>($"api/Matkakohdes/{Id}");
            await base.OnInitializedAsync();
        }
        catch(Exception e){
            Console.WriteLine(e.Message);
        }

    }


    async Task EditLocations()
    {
        try{
            isSubmitting = true;
            var result = await Http.PutAsJsonAsync($"api/Matkakohdes/{Id}", location);

            if (result.StatusCode.Equals("NoContent")) //TÄMÄ EI TOIMI VIELÄ. Tarkoituksena antaa editoijalle viesti, että ei voitu muokata tarinan takia
            {
                r = 1;
            }
            else
            {
                //saako tähän väliin pyöritettyä pyörää?
                NavigationManager.NavigateTo($"/locations");
            }
        }
        catch(Exception e){
            Console.WriteLine(e.Message);
        }
        
    }
}
