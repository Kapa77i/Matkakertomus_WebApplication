@page "/trips/addTrip"

@using System.Net.Http
@using System.Net.Http.Json
@using System.Threading.Tasks

@inject NavigationManager NavigationManager
@inject ILogger<Index> Logger
@inject HttpClient Http
@inject SharedLib.LoginState loginState;

<h3>Lisää matka</h3>

<a href="/trips">Omat matkat</a>

    @*Matkojen lisäysformi (ota huomioon yksityinen/julkinen sekä mahdollinen ryhmämatka?*@
    @if (loginState.isLoggedIn) @*kuka tahansa ei voi lisätä matkoja, vaan pitää olla kirjautunut käyttäjä*@
    {
        <h1>Lisää matkakohde</h1>
        <div style="text-align:center">
            <EditForm Model="@newtrip" OnValidSubmit="@PostTrips">
                <DataAnnotationsValidator />
                <ValidationSummary />
                <div>
                    <label>
                       Matkaaja(t) @*Piilota tai etsi tapa näyttää matkaajan nimi, ota huomioon useamman matkaajan lisääminen?*@
                        <InputNumber class="form-control" id="matkaaja" @bind-Value="newtrip.idmatkaaja" />
                    </label>
                </div>
                <div>
                    <label>
                        Aloitus pvm
                        <InputDate class="form-control" id="alku"  @bind-Value="newtrip.alkupvm" />
                    </label>
                </div>
                <div>
                    <label>
                        Loppu pvm
                        <InputDate class="form-control" id="loppu" @bind-Value="newtrip.loppupvm" />
                    </label>
                </div>
                <div>
                    <label>
                        Yksityisyys
                        <InputRadioGroup class="form-control" id="yksityinen" @bind-Value="newtrip.yksityinen" ><br/>
                            <InputRadio Value="0"/>Yksityinen
                            <InputRadio Value="1"/>Julkinen
                        </InputRadioGroup>
                    </label>
                </div>
                <button type="submit" class="btn btn-primary" disabled="@isSubmitting">Lisää</button>
            </EditForm>
        </div>
    }
    else
    {
        <h2>  <img src="/images/loading.gif" width="150" /></h2>
        <h2>Kirjaudu sisään lisätäksesi matkakohteita</h2>
    }



@code {
    bool isSubmitting;
    SharedLib.matkaDTO? newtrip = new SharedLib.matkaDTO();
    SharedLib.matkaajaDTO? matkaaja = new SharedLib.matkaajaDTO();


    protected override async Task OnInitializedAsync()
    {
        matkaaja = await Http.GetFromJsonAsync<SharedLib.matkaajaDTO>($"api/Matkaajas/{loginState.loggedUser.idmatkaaja}");
        newtrip.idmatkaaja = matkaaja.idmatkaaja;
        newtrip.alkupvm = DateTime.Now;
        newtrip.loppupvm = DateTime.Now;
        await base.OnInitializedAsync();
    }

    async Task PostTrips(){ //EI TOIMI VIELÄ, MIKSI!? -> 400. idmatka näyttää nollaa, mutta ei johdu siitä?
        isSubmitting = true;
        var result = await Http.PostAsJsonAsync($"api/Matkas", newtrip);

        //Ohjataanko postaamisen jälkeen omalle matkasivulle?
        NavigationManager.NavigateTo($"/trips");
    }
}
