@page "/trips/edit/{IdMatka:long}"

@using System.Net.Http
@using System.Net.Http.Json
@using System.Threading.Tasks

@inject NavigationManager NavigationManager
@inject ILogger<Index> Logger
@inject HttpClient Http
@inject SharedLib.LoginState loginState;

<h3>Muokkaa matkaa</h3>

<a href="/trips">Omat matkat</a>
@if (loginState.isLoggedIn) { 


    @if (editTrip != null)
    {@*MATKAA EI VOI MUOKATA, JOS EI OLE OMA*@
                <h3>Muokataan matkaa @editTrip.idmatka</h3>
                <div style="text-align:center">
                    <EditForm Model="@editTrip" OnValidSubmit="@EditTrips">
                        <DataAnnotationsValidator />
                        <ValidationSummary />
                        <div>
                            <label>
                                Matkaaja(t)
                                <InputNumber class="form-control" id="matkaaja" @bind-Value="editTrip.idmatkaaja" />
                            </label>
                        </div>
                        <div>
                            <label>
                                Aloitus pvm
                                <InputDate class="form-control" id="alku" @bind-Value="editTrip.alkupvm" />
                            </label>
                        </div>
                        <div>
                            <label>
                                Loppu pvm
                                <InputDate class="form-control" id="loppu" @bind-Value="editTrip.loppupvm" />
                            </label>
                        </div>
                        <div>
                            <label>
                                Yksityisyys
                                <InputRadioGroup class="form-control" id="yksityinen" @bind-Value="editTrip.yksityinen">
                                    <br />
                                    <InputRadio Value="0" />Yksityinen
                                    <InputRadio Value="1" />Julkinen
                                </InputRadioGroup>
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary" disabled="@isSubmitting">Lisää</button>
                    </EditForm>
                </div>
    }
    @if (r == 1)
    {@*Jos r = 1, se tarkoittaa ettei matkaa muokattu, koska se sisälsi tarinan*@
        <br />
        <div style="text-align:center"><h3>Matka sisältää tarinan.<br />Matkaa ei voi muokata.</h3></div>
    }

}
else{
    <h2>  <img src="/images/loading.gif" width="150" /></h2>
    <h2>Kirjaudu sisään muokataksesi matkoja</h2>
}


@code {
    [Parameter]
    public long? IdMatka { get; set; }

    bool isSubmitting;
    SharedLib.matkaDTO? editTrip; 
    private int? r { get; set; }

    protected override async Task OnInitializedAsync()
    {

        editTrip = await Http.GetFromJsonAsync<SharedLib.matkaDTO>($"api/Matkas/{IdMatka}");

        await base.OnInitializedAsync();
    }


    //TARKISTA TOIMIIKO
    /*Jostain syystä matkan muokkaus onnistuu swaggerissä, jos ei ole annettu mitään tietoja (esim matkaajaa) -> 500 FOREIGN KEY CONSTRAINT FAIL 
     * -> Toimii jos virtual matjaaja on tyhjä?? Swaggeristä syötettynä toimii, miksi ei apista?*/
    async Task EditTrips(){
        try{

            //If radiobuttonia ei valittu -> oletus yksityinen
            isSubmitting = true;
            var result = await Http.PutAsJsonAsync($"api/Matkas/{IdMatka}", editTrip);

            if (result.StatusCode == System.Net.HttpStatusCode.NoContent) //editoijalle viesti, että ei voitu muokata tarinan takia
            {
                r = 1;
            }
            else
            {
                //saako tähän väliin pyöritettyä pyörää?
                NavigationManager.NavigateTo($"/trips");
            }
            
        }
        catch(Exception e){
            Console.WriteLine(e.Message);
        }
        
    }
}
